<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Personal Coach</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0f0f10;
      --panel: #161616;
      --border: #2a2a2a;
      --text: #eaeaea;
      --muted: #9a9a9a;
      --accent: #3ddc97;
      --danger: #ff5c5c;
      --touch: 48px;
    }

    * { box-sizing: border-box }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text);
      font-size: 16px;
      min-height: 100vh;

      /* Hintergrundbild + Abdunklung */
      background:
        linear-gradient(rgba(0, 0, 0, 0.86), rgba(0, 0, 0, 0.86)),
        url("background.jpg") center / cover no-repeat fixed;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);

      background: rgba(15, 15, 16, 0.85);
      backdrop-filter: blur(3px);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    main { padding: 16px }

    button {
      min-height: var(--touch);
      min-width: var(--touch);
      background: #222;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    button.primary {
      background: var(--accent);
      color: #000;
      border: none;
      font-weight: 800;
    }

    button.danger {
      background: transparent;
      border: 1px solid #3a2222;
      color: var(--danger);
    }

    button.chip {
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 14px;
    }

    button.chip.active {
      background: var(--accent);
      color: #000;
      border: none;
      font-weight: 800;
    }

    /* kleine Icon-Buttons (Plan Header) */
    button.icon {
      width: 40px;
      height: 40px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 28px;
      line-height: 1;
    }

    input {
      background: #111;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 10px;
      width: 100%;
      font-size: 16px;
    }

    .card {
      background: rgba(22, 22, 22, 0.92);
      backdrop-filter: blur(2px);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 16px;
    }

    .modal {
      background: rgba(22, 22, 22, 0.95);
      backdrop-filter: blur(4px);
      border: 1px solid var(--border);
      border-radius: 14px;
      width: 100%;
      max-width: 560px;
      padding: 16px;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .big-alert {
      font-size: 40px;
      font-weight: 900;
      text-align: center;
      padding: 22px 14px;
      letter-spacing: 1px;
      line-height: 1.05;
    }

    /* Inputs untereinander */
    .exercise-fields {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .exercise-fields label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 16px;
    }

    .exercise-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    h2 { font-size: 20px; margin: 0 0 12px; }
    h3 { font-size: 17px; margin: 0 0 10px; }

    .exercise-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .trend-pill {
      border: 1px solid var(--border);
      background: rgba(16, 16, 16, 0.85);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      min-width: 44px;
      text-align: center;
    }

    .trend-up { color: var(--accent); border-color: rgba(61, 220, 151, .35); }
    .trend-down { color: var(--danger); border-color: rgba(255, 92, 92, .35); }
    .trend-flat { color: var(--muted); }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Accordion */
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      user-select: none;
    }

    .accordion-title {
      font-size: 18px;
      font-weight: 800;
    }

    .accordion-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    .chev {
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(17, 17, 17, 0.85);
      font-weight: 900;
      padding: 0;
    }

    .accordion-body {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    /* Picker */
    .picker-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

.picker-controls {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  margin: 10px 0;
  align-items: center;
}

.picker-controls .row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

.picker-controls select {
  background: #111;
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 8px;
  padding: 10px;
  font-size: 14px;
}

.pill {
  border: 1px solid var(--border);
  background: rgba(17, 17, 17, 0.85);
  padding: 8px 12px;
  border-radius: 999px;
  font-size: 14px;
  cursor: pointer;
}

.pill.active {
  background: var(--accent);
  color: #000;
  border: none;
  font-weight: 800;
}


    .picker-list {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(17, 17, 17, 0.85);
      max-height: 45vh;
      overflow: auto;
    }

    .pick-item {
      display: grid;
      grid-template-columns: 22px 1fr;
      gap: 12px;
      padding: 12px 10px;
      border-bottom: 1px solid rgba(31, 31, 31, 0.8);
      align-items: start;
    }

    .pick-item input[type="checkbox"] {
      margin: 3px 0 0 0;
      justify-self: start;
    }

    .pick-item>div {
      text-align: left;
      min-width: 0;
    }

    .pick-name {
      font-weight: 800;
      line-height: 1.2;
      word-break: break-word;
    }

    .pick-sub {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.2;
      margin-top: 4px;
      word-break: break-word;
    }

    /* Mobile: fixed background kann ruckeln */
    @media (max-width: 768px) {
      body { background-attachment: scroll; }
    }
  
    header .header-actions{display:flex;gap:10px;align-items:center}
    @media (max-width: 520px){
      header .header-actions{gap:6px}
      header .header-actions button{padding:10px 10px}
    }

  
    /* ========== TRAININGSMODUS (Fokus) ========== */
    .gym-overlay {
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: #000;
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    .gym-topbar {
      position: sticky;
      top: 0;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px;
      border-bottom: 1px solid #222;
      background: rgba(0,0,0,.92);
      backdrop-filter: blur(6px);
    }
    .gym-topbar strong {
      font-weight: 900;
      letter-spacing: .4px;
    }
    .gym-content {
      padding: 16px;
      overflow: auto;
      flex: 1;
    }
    .gym-ex-name {
      font-size: 26px;
      font-weight: 900;
      line-height: 1.15;
      margin: 8px 0 10px;
      word-break: break-word;
    }
    .gym-ex-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }
    .pill {
      border: 1px solid var(--border);
      background: rgba(16,16,16,.85);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .gym-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 12px 0;
    }
    .gym-grid .card {
      margin: 0;
    }
    .gym-footer {
      border-top: 1px solid #222;
      background: rgba(0,0,0,.92);
      backdrop-filter: blur(6px);
      padding: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .gym-footer button.primary {
      min-width: 160px;
    }

    /* ========== MINI-STATS ========== */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin: 0 0 14px 0;
    }
    .stat-card {
      background: rgba(18,18,18,.90);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .stat-title {
      font-weight: 900;
      margin-bottom: 6px;
      word-break: break-word;
    }

    /* ========== MOBILE FEINSCHLIFF ========== */
    @media (max-width: 520px) {
      main { padding: 12px; }
      .card { padding: 12px; }
      button { border-radius: 14px; }
      .gym-ex-name { font-size: 24px; }
      .exercise-title-row strong { font-size: 18px; }
      .picker-row { gap: 8px; }
      button.chip { padding: 10px 14px; }
    }

  </style>
</head>

<body>
  <header>
    <strong>My Personal Coach</strong>
    <div class="header-actions">
      <button onclick="App.exportData()">Export</button>
      <button onclick="App.showImportModal()">Import</button>
      <button onclick="App.showProfileManager()">Profile</button>
    </div>
  </header>

  <main id="app"></main>

  <script>
    /* ================= STORAGE ================= */
    class Storage {
      static key = 'MPC_USERS';
      static load() { return JSON.parse(localStorage.getItem(this.key) || '{}'); }
      static save(data) { localStorage.setItem(this.key, JSON.stringify(data)); }
    }

    /* ================= UI ================= */
    class UI {
      static modal(html) {
        this.closeModal();
        const el = document.createElement('div');
        el.className = 'modal-backdrop';
        el.innerHTML = `<div class="modal">${html}</div>`;
        document.body.appendChild(el);
      }
      static closeModal() {
        // Wenn ein Timer l√§uft, sauber stoppen
        if (window.App && App.timerInterval) {
          App.stopTimer(false);
        }
        const el = document.querySelector('.modal-backdrop');
        if (el) el.remove();
      }
    }

    /* ================= EXERCISE LIBRARY ================= */
    const ExerciseLibrary = {
  brust: [],
  ruecken: [],
  schulter: [],
  bizeps: [],
  trizeps: [],
  beine: [],
  core: [],
  cardio: []
};

const MuscleMeta = {
  brust:    { label: 'Brust' },
  ruecken:  { label: 'R√ºcken' },
  schulter: { label: 'Schulter' },
  bizeps:   { label: 'Bizeps' },
  trizeps:  { label: 'Trizeps' },
  beine:    { label: 'Beine' },
  core:     { label: 'Core' },
  cardio:   { label: 'Cardio' }
};

    async function safeFetchJson(path) {
      const res = await fetch(path + '?v=' + Date.now());
      if (!res.ok) return [];
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }

    async function loadExercises() {
  ExerciseLibrary.brust    = await safeFetchJson('data/brust.json');
  ExerciseLibrary.ruecken  = await safeFetchJson('data/ruecken.json');
  ExerciseLibrary.schulter = await safeFetchJson('data/schulter.json');
  ExerciseLibrary.bizeps   = await safeFetchJson('data/bizeps.json');
  ExerciseLibrary.trizeps  = await safeFetchJson('data/trizeps.json');
  ExerciseLibrary.beine    = await safeFetchJson('data/beine.json');
  ExerciseLibrary.core     = await safeFetchJson('data/core.json');
  ExerciseLibrary.cardio   = await safeFetchJson('data/cardio.json');
}

    function uniq(arr) {
      return [...new Set(arr.filter(Boolean))];
    }

    function normCategory(cat) {
      return String(cat || '').trim().toLowerCase();
    }

    /* ================= APP ================= */
    class App {
      static users = Storage.load();
      static currentUser = null;

      /* Timer */
      static timerInterval = null;

      /* Accordion state (pro Profil gespeichert) */
      static openPlanIndex = null;

      /* Picker state */
      static picker = {
  planIndex: null,
  muscle: null,
  category: null,
  query: '',
  selectedOnly: false,
  sort: 'name_asc' // name_asc | name_desc | selected_first
};

      static async init() {
        await loadExercises();

        const names = Object.keys(this.users);
        if (names.length) {
          this.currentUser = names[0];
          this.ensureUserState();
          this.render();
        } else {
          this.showProfileManager();
        }
      }

      static ensureUserState() {
        const u = this.users[this.currentUser];
        if (!u.state) u.state = {};
        if (typeof u.state.openPlanIndex !== 'number') {
          u.state.openPlanIndex = (u.plans && u.plans.length) ? 0 : null;
        }
        this.openPlanIndex = u.state.openPlanIndex;
        Storage.save(this.users);
      }

      static setOpenPlan(index) {
        const u = this.users[this.currentUser];
        if (!u.state) u.state = {};
        if (this.openPlanIndex === index) this.openPlanIndex = null;
        else this.openPlanIndex = index;
        u.state.openPlanIndex = this.openPlanIndex;
        Storage.save(this.users);
        this.render();
      }

      /* -------- Profiles -------- */
      static showProfileManager() {
        UI.modal(`
          <div class="modal-head">
            <h3 style="margin:0;">Profile</h3>
            <button onclick="UI.closeModal()">‚úï</button>
          </div>

          ${Object.keys(this.users).map(n => `
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                <strong>${n}</strong>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button onclick="App.selectProfile('${n}')">√ñffnen</button>
                  <button class="danger" onclick="App.deleteProfile('${n}')">L√∂schen</button>
                </div>
              </div>
            </div>
          `).join('')}

          <div class="exercise-fields">
            <label>
              Neues Profil
              <input id="newProfile" placeholder="Name">
            </label>
            <button class="primary" onclick="App.createProfile()">Erstellen</button>
          </div>
        `);
      }

      static createProfile() {
        const name = document.getElementById('newProfile').value.trim();
        if (!name) return;
        this.users[name] = { plans: [], state: { openPlanIndex: null } };
        Storage.save(this.users);
        this.currentUser = name;
        UI.closeModal();
        this.ensureUserState();
        this.render();
      }

      static selectProfile(name) {
        this.currentUser = name;
        UI.closeModal();
        this.ensureUserState();
        this.render();
      }

      static deleteProfile(name) {
        delete this.users[name];
        Storage.save(this.users);
        this.currentUser = null;
        UI.closeModal();
        this.init();
      }

      
      /* -------- Import / Export -------- */
      static exportData() {
        try {
          const payload = {
            _meta: {
              app: 'My Personal Coach',
              exportVersion: 1,
              exportedAt: new Date().toISOString()
            },
            users: this.users
          };
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const d = new Date();
          const stamp = d.toISOString().slice(0,10);
          a.href = url;
          a.download = `mpc_export_${stamp}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (e) {
          alert('Export fehlgeschlagen. Pr√ºfe Konsole.');
          console.error(e);
        }
      }

      static showImportModal() {
        UI.modal(`
          <div class="modal-head">
            <div>
              <h3 style="margin:0;">Import</h3>
              <div class="hint">JSON-Datei aus einem MPC-Export ausw√§hlen. Import wirkt nur lokal auf diesem Ger√§t.</div>
            </div>
            <button onclick="UI.closeModal()">‚úï</button>
          </div>

          <div class="exercise-fields">
            <label>
              Export-Datei ausw√§hlen
              <input id="importFile" type="file" accept="application/json">
            </label>

            <div class="card" style="background:rgba(18,18,18,0.90); border-color:#252525;">
              <div class="hint">
                <strong>√úberschreiben</strong> ersetzt alles auf diesem Ger√§t.<br>
                <strong>Zusammenf√ºhren</strong> beh√§lt vorhandene Profile und f√ºgt Import-Inhalte hinzu (bei Namenskonflikten werden Pl√§ne als ‚Äû(import)‚Äú angeh√§ngt).
              </div>
            </div>

            <div class="exercise-actions" style="justify-content:flex-end;">
              <button onclick="UI.closeModal()">Abbrechen</button>
              <button class="danger" onclick="App.importData('overwrite')">√úberschreiben</button>
              <button class="primary" onclick="App.importData('merge')">Zusammenf√ºhren</button>
            </div>
          </div>
        `);
      }

      static async importData(mode) {
        const input = document.getElementById('importFile');
        const file = input && input.files && input.files[0];
        if (!file) {
          alert('Bitte zuerst eine JSON-Datei ausw√§hlen.');
          return;
        }

        try {
          const text = await file.text();
          const parsed = JSON.parse(text);

          const importedUsers = parsed && parsed.users ? parsed.users : parsed; // erlaubt auch reine users-Objekte
          if (!importedUsers || typeof importedUsers !== 'object' || Array.isArray(importedUsers)) {
            alert('Import-Datei ist ung√ºltig (kein users-Objekt).');
            return;
          }

          if (mode === 'overwrite') {
            const ok = confirm('Wirklich alles auf diesem Ger√§t √ºberschreiben?');
            if (!ok) return;
            this.users = importedUsers;
            Storage.save(this.users);
            UI.closeModal();
            this.currentUser = Object.keys(this.users)[0] || null;
            location.reload();
            return;
          }

          // merge
          this.users = this.users || {};
          for (const [profileName, profileData] of Object.entries(importedUsers)) {
            if (!this.users[profileName]) {
              this.users[profileName] = profileData;
              continue;
            }

            // Profil existiert: Pl√§ne zusammenf√ºhren
            const target = this.users[profileName];
            if (!target.plans) target.plans = [];
            const incomingPlans = (profileData && profileData.plans) ? profileData.plans : [];

            for (const plan of incomingPlans) {
              const cloned = JSON.parse(JSON.stringify(plan || {}));
              const baseName = (cloned.name || 'Plan').trim();
              let newName = baseName;

              // Namenskonflikte vermeiden
              const existingNames = new Set(target.plans.map(p => (p.name || '').trim()));
              if (existingNames.has(newName)) {
                newName = `${baseName} (import)`;
                let n = 2;
                while (existingNames.has(newName)) {
                  newName = `${baseName} (import ${n})`;
                  n++;
                }
              }
              cloned.name = newName;
              target.plans.push(cloned);
            }

            // Logs/State (falls vorhanden) vorsichtig mergen
            if (profileData && profileData.state && !target.state) {
              target.state = profileData.state;
            }
          }

          Storage.save(this.users);
          UI.closeModal();
          location.reload();
        } catch (e) {
          alert('Import fehlgeschlagen. Datei ist vermutlich keine g√ºltige MPC-JSON.');
          console.error(e);
        }
      }


      /* -------- Plan bearbeiten/l√∂schen -------- */
      static renamePlan(planIndex) {
        const plan = this.users[this.currentUser].plans[planIndex];
        if (!plan) return;

        const name = prompt('Neuer Planname:', plan.name || '');
        if (!name || !name.trim()) return;

        plan.name = name.trim();
        Storage.save(this.users);
        this.render();
      }

      static deletePlan(planIndex) {
        const plans = this.users[this.currentUser].plans;
        const plan = plans[planIndex];
        if (!plan) return;

        const ok = confirm(`Plan "${plan.name}" wirklich l√∂schen?`);
        if (!ok) return;

        plans.splice(planIndex, 1);

        const u = this.users[this.currentUser];
        if (!u.state) u.state = {};

        if (this.openPlanIndex === planIndex) {
          this.openPlanIndex = null;
          u.state.openPlanIndex = null;
        } else if (typeof this.openPlanIndex === 'number' && this.openPlanIndex > planIndex) {
          this.openPlanIndex = this.openPlanIndex - 1;
          u.state.openPlanIndex = this.openPlanIndex;
        }

        Storage.save(this.users);
        this.render();
      }

      /* -------- Trend helpers -------- */
      static trendSymbol(trend) {
        if (trend === 'up') return '‚Üë';
        if (trend === 'down') return '‚Üì';
        return '~';
      }
      static trendClass(trend) {
        if (trend === 'up') return 'trend-up';
        if (trend === 'down') return 'trend-down';
        return 'trend-flat';
      }

      static setTrend(planIndex, exIndex, trend) {
        const ex = this.users[this.currentUser].plans[planIndex].exercises[exIndex];
        if (!ex) return;

        ex.trend = ex.trend || 'flat';
        ex.trendPrev = ex.trendPrev ?? null;
        ex.streakUp = ex.streakUp || 0;
        ex.streakDown = ex.streakDown || 0;

        ex.trend = trend;

        if (trend === 'up') {
          ex.streakUp = (ex.trendPrev === 'up') ? (ex.streakUp + 1) : 1;
          ex.streakDown = 0;
        } else if (trend === 'down') {
          ex.streakDown = (ex.trendPrev === 'down') ? (ex.streakDown + 1) : 1;
          ex.streakUp = 0;
        } else {
          ex.streakUp = 0;
          ex.streakDown = 0;
        }

        ex.trendPrev = trend;

        Storage.save(this.users);
        this.render();

        if (ex.streakUp >= 2) {
          UI.modal(`
            <div class="big-alert">Geil!! Gewicht hoch, Herkules</div>
            <div class="exercise-actions" style="justify-content:center;">
              <button class="primary" onclick="UI.closeModal()">OK</button>
            </div>
          `);
        } else if (ex.streakDown >= 2) {
          UI.modal(`
            <div class="big-alert">Geh lieber mal mit dem Gewicht runter, du Lauch</div>
            <div class="exercise-actions" style="justify-content:center;">
              <button class="primary" onclick="UI.closeModal()">OK</button>
            </div>
          `);
        }
      }

      /* -------- Exercise Picker -------- */
      static openExercisePicker(planIndex) {
  this.picker.planIndex = planIndex;

  const muscleKeysAll = Object.keys(ExerciseLibrary);
  const muscleKeys = muscleKeysAll.filter(k => Array.isArray(ExerciseLibrary[k]) && ExerciseLibrary[k].length);
  const safeMuscleKeys = muscleKeys.length ? muscleKeys : muscleKeysAll;

  if (!this.picker.muscle || !safeMuscleKeys.includes(this.picker.muscle)) {
    this.picker.muscle = safeMuscleKeys[0] || 'brust';
  }

  // Kategorien + "Alle"
  const cats = this.getCategories(this.picker.muscle);
  const catsWithAll = ['__all__', ...cats];

  if (!this.picker.category || !catsWithAll.includes(this.picker.category)) {
    this.picker.category = '__all__';
  }

  const plan = this.users[this.currentUser].plans[planIndex];

  const muscleTabs = safeMuscleKeys.map(k => {
    const label = MuscleMeta[k]?.label || k;
    const active = (this.picker.muscle === k) ? 'active' : '';
    return `<button class="chip ${active}" onclick="App.setPickerMuscle('${k}')">${label}</button>`;
  }).join('');

  const catTabs = catsWithAll.length ? catsWithAll.map(c => {
    const isAll = c === '__all__';
    const active = (this.picker.category === c) ? 'active' : '';
    return `<button class="chip ${active}" onclick="App.setPickerCategory('${c}')">${isAll ? 'Alle' : this.prettyCategory(c)}</button>`;
  }).join('') : `<div class="hint">Keine Kategorien gefunden. Pr√ºfe deine JSON-Felder: "kategorie".</div>`;

  // Search + Filter + Sort
  const selectedCount = (plan.exercises || []).length;
  const selectedOnlyActive = this.picker.selectedOnly ? 'active' : '';

  const sortOptions = `
    <select onchange="App.setPickerSort(this.value)">
      <option value="name_asc" ${this.picker.sort==='name_asc'?'selected':''}>Name A‚ÄìZ</option>
      <option value="name_desc" ${this.picker.sort==='name_desc'?'selected':''}>Name Z‚ÄìA</option>
      <option value="selected_first" ${this.picker.sort==='selected_first'?'selected':''}>Ausgew√§hlt zuerst</option>
    </select>
  `;

  const controls = `
    <div class="picker-controls">
      <div>
        <input id="pickerSearch" placeholder="Suche nach Name oder ID‚Ä¶"
          value="${this.escapeHtml(this.picker.query)}"
          oninput="App.setPickerQuery(this.value)">
        <div class="hint" style="margin-top:6px;">
          Treffer werden live gefiltert. Tipp: Such auch nach "_" oder "press".
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;">
        <button class="pill ${selectedOnlyActive}" onclick="App.toggleSelectedOnly()">
          Nur ausgew√§hlte (${selectedCount})
        </button>
        ${sortOptions}
      </div>
    </div>
  `;

  const list = this.getExercisesForPickerFiltered(plan, this.picker.muscle, this.picker.category, this.picker.query, this.picker.selectedOnly, this.picker.sort);

  const listHtml = list.length ? list.map(ex => {
    const checked = (plan.exercises || []).some(pe => pe.id === ex.id);
    const sub = ex.kategorie ? this.prettyCategory(normCategory(ex.kategorie)) : '';
    return `
      <div class="pick-item">
        <input type="checkbox" ${checked ? 'checked' : ''} onchange="App.toggleExercise(${planIndex}, '${this.picker.muscle}', '${ex.id}')">
        <div>
          <div class="pick-name">${this.escapeHtml(ex.name || ex.id)}</div>
          <div class="pick-sub">${this.escapeHtml(sub)}${ex.id ? ' ‚Ä¢ ' + this.escapeHtml(ex.id) : ''}</div>
        </div>
      </div>
    `;
  }).join('') : `<div class="hint">Keine Treffer. Check Suchbegriff, Kategorie oder "Nur ausgew√§hlte".</div>`;

  UI.modal(`
    <div class="modal-head">
      <div>
        <h3 style="margin:0;">√úbungen ausw√§hlen</h3>
        <div class="hint">Muskelgruppe ‚Üí Kategorie ‚Üí Suche/Filter ‚Üí Checkbox</div>
      </div>
      <button onclick="UI.closeModal()">‚úï</button>
    </div>

    <div class="picker-row">${muscleTabs}</div>
    <div class="picker-row">${catTabs}</div>

    ${controls}

    <div class="picker-list">
      ${listHtml}
    </div>

    <div class="exercise-actions" style="justify-content:space-between; margin-top:12px;">
      <div class="hint">Tipp: "Alle" + Suche = schnellster Weg.</div>
      <button class="primary" onclick="UI.closeModal()">Fertig</button>
    </div>
  `);

  // Fokus auf Suche (nur wenn Modal neu ist)
  setTimeout(() => {
    const s = document.getElementById('pickerSearch');
    if (s) s.focus();
  }, 0);
}

static setPickerMuscle(muscle) {
        this.picker.muscle = muscle;
        const cats = this.getCategories(muscle);
        this.picker.category = cats[0] || null;
        this.openExercisePicker(this.picker.planIndex);
      }

      static setPickerCategory(category) {
        this.picker.category = category;
        this.openExercisePicker(this.picker.planIndex);
      }

      static getCategories(muscle) {
        const arr = ExerciseLibrary[muscle] || [];
        return uniq(arr.map(e => normCategory(e.kategorie))).sort();
      }

      static escapeHtml(str) {
  return String(str ?? '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

static setPickerQuery(q) {
  this.picker.query = String(q || '');
  this.openExercisePicker(this.picker.planIndex);
}

static toggleSelectedOnly() {
  this.picker.selectedOnly = !this.picker.selectedOnly;
  this.openExercisePicker(this.picker.planIndex);
}

static setPickerSort(sort) {
  this.picker.sort = sort || 'name_asc';
  this.openExercisePicker(this.picker.planIndex);
}

static prettyCategory(cat) {
        const map = {
          langhantel: 'Langhantel',
          kurzhantel: 'Kurzhantel',
          maschine: 'Maschine',
          kabel: 'Kabel',
          koerpergewicht: 'K√∂rpergewicht',
          band: 'Band',
          sonstiges: 'Sonstiges',
          kettlebell: 'Kettlebell'
        };
        return map[cat] || (cat ? cat.charAt(0).toUpperCase() + cat.slice(1) : '');
      }

      static getExercisesForPicker(muscle, category) {
  const arr = ExerciseLibrary[muscle] || [];
  const c = normCategory(category);
  if (!c || c === '__all__') return [...arr];
  return arr.filter(e => normCategory(e.kategorie) === c);
}

static getExercisesForPickerFiltered(plan, muscle, category, query, selectedOnly, sort) {
  const q = String(query || '').trim().toLowerCase();
  const selectedIds = new Set((plan.exercises || []).map(e => e.id));

  let list = this.getExercisesForPicker(muscle, category);

  if (q) {
    list = list.filter(e => {
      const n = String(e.name || '').toLowerCase();
      const id = String(e.id || '').toLowerCase();
      return n.includes(q) || id.includes(q);
    });
  }

  if (selectedOnly) {
    list = list.filter(e => selectedIds.has(e.id));
  }

  // Sort
  if (sort === 'selected_first') {
    list = list.sort((a, b) => {
      const aSel = selectedIds.has(a.id) ? 0 : 1;
      const bSel = selectedIds.has(b.id) ? 0 : 1;
      if (aSel !== bSel) return aSel - bSel;
      return String(a.name || '').localeCompare(String(b.name || ''), 'de');
    });
  } else if (sort === 'name_desc') {
    list = list.sort((a, b) => String(b.name || '').localeCompare(String(a.name || ''), 'de'));
  } else {
    list = list.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''), 'de'));
  }

  return list;
}

static toggleExercise(planIndex, muscle, id) {
        const plan = this.users[this.currentUser].plans[planIndex];
        if (!plan.exercises) plan.exercises = [];

        const src = (ExerciseLibrary[muscle] || []);
        const ex = src.find(e => String(e.id) === String(id));
        if (!ex) return;

        const idx = plan.exercises.findIndex(pe => pe.id === ex.id);

        if (idx >= 0) {
          plan.exercises.splice(idx, 1);
        } else {
          plan.exercises.push({
            id: ex.id,
            name: ex.name || ex.id,
            kategorie: normCategory(ex.kategorie),
            saetze: ex.saetze ?? ex.saetze_ziel ?? 3,
            wdh: ex.wdh ?? ex.wdh_ziel ?? '12',
            weight: ex.weight ?? ex.startgewicht ?? 0,
            timer: ex.timer ?? 75,
            trend: 'flat',
            trendPrev: null,
            streakUp: 0,
            streakDown: 0,
            history: []
          });
        }

        Storage.save(this.users);
        this.render();
        this.openExercisePicker(planIndex);
      }

      /* -------- UI -------- */
      static render() {
        const user = this.users[this.currentUser];
        const plans = user.plans || [];

        document.getElementById('app').innerHTML = `
          <h2>${this.currentUser}</h2>

          ${this.renderMiniStats()}

          ${plans.length ? plans.map((p, i) => `
            <div class="card">
              <div class="accordion-header">
                <div style="flex:1; min-width:0;">
                  <div class="accordion-title">${p.name}</div>
                  <div class="accordion-meta">
                    ${(p.exercises?.length || 0)} √úbungen
                    ${this.openPlanIndex === i ? '‚Ä¢ aktiv' : ''}
                  </div>
                </div>

                <div class="exercise-actions" style="justify-content:flex-end;">
                  <button class="icon" title="Plan umbenennen" onclick="App.renamePlan(${i})">‚úèÔ∏è</button>
                  <button class="icon danger" title="Plan l√∂schen" onclick="App.deletePlan(${i})">üóë</button>
                  <button class="chev" title="Plan √∂ffnen/schlie√üen" onclick="App.setOpenPlan(${i})">
                    ${this.openPlanIndex === i ? '‚àí' : '+'}
                  </button>
                </div>
              </div>

              ${this.openPlanIndex === i ? `
                <div class="accordion-body">
                  ${(p.exercises || []).map((ex, ei) => `
                    <div class="card" style="margin-top:12px;">
                      <div class="exercise-title-row">
                        <strong style="font-size:18px;">${ex.name}</strong>
                        <div class="trend-pill ${App.trendClass(ex.trend)}" title="Trend gespeichert">
                          ${App.trendSymbol(ex.trend)}
                        </div>
                      </div>

                      ${App.lastLogLine(ex)}

                      <div class="exercise-fields">
                        <label>
                          S√§tze
                          <input type="number" min="1" value="${ex.saetze ?? 3}"
                            onchange="App.update(${i},${ei},'saetze',this.value)">
                        </label>

                        <label>
                          Wiederholungen (Ziel)
                          <input type="text" value="${ex.wdh ?? '12'}"
                            onchange="App.update(${i},${ei},'wdh',this.value)">
                        </label>

                        <label>
                          Gewicht
                          <input type="number" min="0" value="${ex.weight ?? 0}"
                            onchange="App.update(${i},${ei},'weight',this.value)">
                        </label>

                        <label>
                          Timer (Sek.)
                          <input type="number" min="5" value="${ex.timer ?? 75}"
                            onchange="App.update(${i},${ei},'timer',this.value)">
                        </label>

                        <div class="card" style="background:rgba(18,18,18,0.90); border-color:#252525;">
                          <div class="hint" style="margin-bottom:10px;">
                            Trend speichern: 2√ó ‚Üë = Gewicht hoch / 2√ó ‚Üì = Gewicht runter
                          </div>

                          <div class="exercise-actions">
                            <button onclick="App.setTrend(${i},${ei},'up')" title="Besser / zu leicht">‚Üë</button>
                            <button onclick="App.setTrend(${i},${ei},'flat')" title="Passt / getroffen">~</button>
                            <button onclick="App.setTrend(${i},${ei},'down')" title="Schlechter / zu schwer">‚Üì</button>

                            <span class="trend-pill ${App.trendClass(ex.trend)}" style="margin-left:auto;">
                              ${App.trendSymbol(ex.trend)}
                            </span>
                          </div>
                        </div>

                        <div class="exercise-actions">
                          <button onclick="App.showExerciseInfo(${i},${ei})">Erkl√§rung</button>
                          <button onclick="App.startTimer(${i},${ei})">Timer starten</button>
                          <button class="danger" onclick="App.removeExercise(${i},${ei})">√úbung l√∂schen</button>
                        </div>
                      </div>
                    </div>
                  `).join('')}

                  <div style="margin-top:12px;" class="exercise-actions">
                    <button class="primary" onclick="App.startGymMode(${i})">Training starten</button>
                    <button onclick="App.saveWorkout(${i})">Training speichern</button>
                    <button onclick="App.openExercisePicker(${i})">√úbungen ausw√§hlen</button>
                  </div>
                </div>
              ` : ''}
            </div>
          `).join('') : `
            <div class="card">
              <div class="hint">Noch keine Pl√§ne vorhanden. Erstell dir einen und klapp ihn auf.</div>
            </div>
          `}

          <button class="primary" onclick="App.addPlan()">Plan hinzuf√ºgen</button>
        `;
      }

      static addPlan() {
        const name = prompt('Planname');
        if (!name) return;

        this.users[this.currentUser].plans.push({ name, exercises: [] });

        const newIndex = this.users[this.currentUser].plans.length - 1;
        if (!this.users[this.currentUser].state) this.users[this.currentUser].state = {};
        this.openPlanIndex = newIndex;
        this.users[this.currentUser].state.openPlanIndex = newIndex;

        Storage.save(this.users);
        this.render();
      }

      static update(pi, ei, field, value) {
        const ex = this.users[this.currentUser].plans[pi].exercises[ei];
        if (!ex) return;

        if (field === 'saetze') ex.saetze = Math.max(1, parseInt(value || '1', 10));
        else if (field === 'weight') ex.weight = Math.max(0, parseFloat(value || '0'));
        else if (field === 'timer') ex.timer = Math.max(5, parseInt(value || '75', 10));
        else if (field === 'wdh') ex.wdh = String(value || '').trim();
        else ex[field] = value;

        Storage.save(this.users);
        this.render();
      }

      static removeExercise(planIndex, exIndex) {
        this.users[this.currentUser].plans[planIndex].exercises.splice(exIndex, 1);
        Storage.save(this.users);
        this.render();
      }

      
      /* -------- TRAINING LOG (minimal) -------- */
      static isoToday() {
        // YYYY-MM-DD
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      }

      static formatDateDE(isoDate) {
        // isoDate: YYYY-MM-DD -> DD.MM.YYYY
        if (!isoDate || typeof isoDate !== 'string') return '';
        const [y, m, d] = isoDate.split('-');
        if (!y || !m || !d) return isoDate;
        return `${d}.${m}.${y}`;
      }

      
      /* ================= MINI-STATS (letzte 4 Trainings) ================= */
      static ensureUserCollections() {
        const u = this.users[this.currentUser];
        if (!u) return;
        if (!Array.isArray(u.workoutSessions)) u.workoutSessions = [];
      }

      static appendWorkoutSession(session) {
        this.ensureUserCollections();
        const u = this.users[this.currentUser];
        // Dedup: wenn direkt zweimal hintereinander gleicher Plan+Datum gespeichert wird, nur einmal.
        const last = u.workoutSessions[u.workoutSessions.length - 1];
        if (last && last.date === session.date && last.planName === session.planName) return;

        u.workoutSessions.push({
          date: session.date,
          planName: session.planName,
          exerciseCount: session.exerciseCount ?? 0
        });

        // Cap: keep it lean
        if (u.workoutSessions.length > 60) u.workoutSessions = u.workoutSessions.slice(-60);

        Storage.save(this.users);
      }

      static getRecentSessions(limit = 4) {
        this.ensureUserCollections();
        const u = this.users[this.currentUser];
        return (u.workoutSessions || []).slice(-limit).reverse();
      }

      static renderMiniStats() {
        const recent = this.getRecentSessions(4);
        if (!recent.length) {
          return `<div class="card"><div class="hint">Noch keine Trainings gespeichert. (Im Plan: ‚ÄûTraining speichern‚Äú oder im Fokus-Modus ‚ÄûBeenden & speichern‚Äú.)</div></div>`;
        }
        return `
          <div class="stats-row">
            ${recent.map(s => `
              <div class="stat-card">
                <div class="stat-title">${this.escapeHtml(s.planName || 'Plan')}</div>
                <div class="hint">${this.formatDateDE(s.date)} ‚Ä¢ ${s.exerciseCount || 0} √úbungen</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      /* ================= TRAININGSMODUS (Fokus) ================= */
      static gym = null;

      static startGymMode(planIndex) {
        const plan = this.users[this.currentUser]?.plans?.[planIndex];
        if (!plan || !Array.isArray(plan.exercises) || !plan.exercises.length) return;

        // Session-State: pro √úbung Satz-Fortschritt (rein UI, kein Overkill)
        this.gym = {
          planIndex,
          exIndex: 0,
          setDone: plan.exercises.map(() => 0)
        };
        this.renderGym();
      }

      static exitGymMode() {
        const el = document.getElementById('gymOverlay');
        if (el) el.remove();
        this.gym = null;
      }

      static gymPrev() {
        if (!this.gym) return;
        this.gym.exIndex = Math.max(0, this.gym.exIndex - 1);
        this.renderGym();
      }

      static gymNext() {
        if (!this.gym) return;
        const plan = this.users[this.currentUser].plans[this.gym.planIndex];
        this.gym.exIndex = Math.min(plan.exercises.length - 1, this.gym.exIndex + 1);
        this.renderGym();
      }

      static gymSetDone() {
        if (!this.gym) return;
        const plan = this.users[this.currentUser].plans[this.gym.planIndex];
        const ex = plan.exercises[this.gym.exIndex];
        const target = Math.max(1, parseInt(ex.saetze || 1, 10));
        const cur = this.gym.setDone[this.gym.exIndex] || 0;
        this.gym.setDone[this.gym.exIndex] = Math.min(target, cur + 1);

        // Auto-Next wenn Satz-Ziel erreicht
        if (this.gym.setDone[this.gym.exIndex] >= target) {
          this.gymNext();
        } else {
          this.renderGym();
        }
      }

      static gymSetUndo() {
        if (!this.gym) return;
        const cur = this.gym.setDone[this.gym.exIndex] || 0;
        this.gym.setDone[this.gym.exIndex] = Math.max(0, cur - 1);
        this.renderGym();
      }

      static gymFinishAndSave() {
        if (!this.gym) return;
        const pi = this.gym.planIndex;
        this.saveWorkout(pi); // speichert pro √úbung + Session-Log
        this.exitGymMode();
      }

      static renderGym() {
        const g = this.gym;
        if (!g) return;

        const plan = this.users[this.currentUser].plans[g.planIndex];
        const ex = plan.exercises[g.exIndex];

        const done = g.setDone[g.exIndex] || 0;
        const target = Math.max(1, parseInt(ex.saetze || 1, 10));

        // Meta aus Library (f√ºr Kategorie/Muskel)
        const found = this.findExerciseById(ex.id);
        const muscleLabel = found ? (MuscleMeta[found.muscle]?.label || found.muscle) : 'Unbekannt';
        const cat = found?.ex?.kategorie || ex.kategorie || '';

        // Overlay erstellen/aktualisieren
        let overlay = document.getElementById('gymOverlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'gymOverlay';
          overlay.className = 'gym-overlay';
          document.body.appendChild(overlay);
        }

        overlay.innerHTML = `
          <div class="gym-topbar">
            <button class="danger" onclick="App.exitGymMode()">Beenden</button>
            <strong>${this.escapeHtml(plan.name || 'Training')}</strong>
            <div class="pill">${g.exIndex + 1}/${plan.exercises.length}</div>
          </div>

          <div class="gym-content">
            <div class="gym-ex-meta">
              <div class="pill">${this.escapeHtml(muscleLabel)}${cat ? ' ‚Ä¢ ' + this.escapeHtml(String(cat)) : ''}</div>
              <div class="pill">Gewicht: ${this.escapeHtml(String(ex.weight ?? 0))}</div>
              <div class="pill">Ziel: ${this.escapeHtml(String(ex.wdh ?? '0'))}</div>
            </div>

            <div class="gym-ex-name">${this.escapeHtml(ex.name || ex.id)}</div>

            <div class="card" style="background:rgba(18,18,18,0.90); border-color:#252525;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                <div style="font-weight:900;">S√§tze</div>
                <div class="pill">${done}/${target}</div>
              </div>
              <div class="gym-grid" style="margin-top:10px;">
                <button onclick="App.gymSetUndo()">Satz zur√ºck</button>
                <button class="primary" onclick="App.gymSetDone()">Satz erledigt</button>
              </div>
            </div>

            <div class="card" style="background:rgba(18,18,18,0.90); border-color:#252525;">
              <div class="hint" style="margin-bottom:10px;">
                Trend speichern: 2√ó ‚Üë = Gewicht hoch / 2√ó ‚Üì = Gewicht runter
              </div>
              <div class="exercise-actions">
                <button onclick="App.setTrend(${g.planIndex},${g.exIndex},'up')">‚Üë</button>
                <button onclick="App.setTrend(${g.planIndex},${g.exIndex},'flat')">~</button>
                <button onclick="App.setTrend(${g.planIndex},${g.exIndex},'down')">‚Üì</button>
                <span class="trend-pill ${App.trendClass(ex.trend)}" style="margin-left:auto;">
                  ${App.trendSymbol(ex.trend)}
                </span>
              </div>
            </div>

            <div class="gym-grid">
              <button onclick="App.showExerciseInfo(${g.planIndex},${g.exIndex})">Erkl√§rung</button>
              <button onclick="App.startTimer(${g.planIndex},${g.exIndex})">Timer</button>
            </div>
          </div>

          <div class="gym-footer">
            <button onclick="App.gymPrev()">‚Üê</button>
            <button onclick="App.gymNext()">‚Üí</button>
            <button class="primary" onclick="App.gymFinishAndSave()">Beenden & speichern</button>
          </div>
        `;
      }


      static getLastLog(ex) {
        const h = ex?.history;
        if (!Array.isArray(h) || !h.length) return null;
        return h[h.length - 1];
      }

      static lastLogLine(ex) {
        const last = App.getLastLog(ex);
        if (!last) return `<div class="hint" style="margin:6px 0 2px;">Kein Log-Eintrag gespeichert.</div>`;
        const dt = App.formatDateDE(last.date);
        const w = (last.weight ?? 0);
        const s = (last.saetze ?? '');
        const r = (last.wdh ?? '');
        return `<div class="hint" style="margin:6px 0 2px;">Letztes Training: <strong>${dt}</strong> ‚Ä¢ ${w} ‚Ä¢ ${s}√ó${r} ‚Ä¢ Trend: ${App.trendSymbol(last.trend)}</div>`;
      }

      static saveWorkout(planIndex) {
        const plan = this.users[this.currentUser]?.plans?.[planIndex];
        if (!plan || !Array.isArray(plan.exercises) || !plan.exercises.length) return;

        const date = this.isoToday();

        // Session-Log (f√ºr Mini-Statistik)
        this.appendWorkoutSession({ date, planName: plan.name || 'Plan', exerciseCount: plan.exercises.length });

        // Minimal-Session: Snapshot pro √úbung. (Kein Overkill, kein Satz-Tracking.)
        for (const ex of plan.exercises) {
          if (!Array.isArray(ex.history)) ex.history = [];
          ex.history.push({
            date,
            weight: ex.weight ?? 0,
            saetze: ex.saetze ?? 0,
            wdh: ex.wdh ?? '0',
            trend: ex.trend ?? 'flat'
          });

          // Cap: h√§lt LocalStorage schlank
          if (ex.history.length > 30) ex.history = ex.history.slice(-30);
        }

        Storage.save(this.users);
        this.render();

        UI.modal(`
          <div class="modal-head">
            <h3 style="margin:0;">Training gespeichert</h3>
            <button onclick="UI.closeModal()">‚úï</button>
          </div>
          <div class="hint">Datum: ${this.formatDateDE(date)} ‚Ä¢ Plan: <strong>${plan.name || ''}</strong></div>
          <div class="exercise-actions" style="justify-content:flex-end; margin-top:12px;">
            <button class="primary" onclick="UI.closeModal()">OK</button>
          </div>
        `);
      }


      /* -------- √úBUNGSDETAILS (Punkt 4) -------- */
      static escapeHtml(str) {
        return String(str ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      static findExerciseById(id) {
        const target = String(id);
        for (const muscle of Object.keys(ExerciseLibrary)) {
          const arr = ExerciseLibrary[muscle] || [];
          const ex = arr.find(e => String(e.id) === target);
          if (ex) return { muscle, ex };
        }
        return null;
      }

      static showExerciseInfo(planIndex, exIndex) {
        const plan = this.users[this.currentUser]?.plans?.[planIndex];
        const pex = plan?.exercises?.[exIndex];
        if (!pex) return;

        const found = this.findExerciseById(pex.id);
        const title = this.escapeHtml(pex.name || pex.id);
        const id = this.escapeHtml(pex.id || '');
        const muscleLabel = found ? (MuscleMeta[found.muscle]?.label || found.muscle) : 'Unbekannt';
        const cat = found?.ex?.kategorie ? this.escapeHtml(found.ex.kategorie) : this.escapeHtml(pex.kategorie || '');
        const desc = found?.ex?.beschreibung ? this.escapeHtml(found.ex.beschreibung) : 'Keine Beschreibung gefunden (√úbung nicht in Library).';
        const img = found?.ex?.bild;

        UI.modal(`
          <div class="modal-head">
            <div style="min-width:0;">
              <h3 style="margin:0;word-break:break-word;">${title}</h3>
              <div class="hint" style="margin-top:4px;">${this.escapeHtml(muscleLabel)}${cat ? ' ‚Ä¢ ' + cat : ''}${id ? ' ‚Ä¢ ' + id : ''}</div>
            </div>
            <button onclick="UI.closeModal()">‚úï</button>
          </div>

          <div class="card" style="background:rgba(18,18,18,0.90); border-color:#252525;">
            <div style="font-weight:800;margin-bottom:8px;">Ausf√ºhrung</div>
            <div style="white-space:pre-wrap;line-height:1.5;">${desc}</div>
          </div>

          <div class="card" style="background:rgba(18,18,18,0.90); border-color:#252525;">
            <div style="font-weight:800;margin-bottom:8px;">Bild</div>
            ${
              img
                ? `<img src="${this.escapeHtml(img)}" alt="${title}" style="width:100%;border-radius:12px;border:1px solid var(--border);" />`
                : `<div class="hint">Noch kein Bild hinterlegt. (Feld <code>bild</code> ist <code>null</code>)</div>`
            }
          </div>

          <div class="exercise-actions" style="justify-content:flex-end;">
            <button class="primary" onclick="UI.closeModal()">OK</button>
          </div>
        `);
      }

      /* -------- TIMER -------- */
      static startTimer(pi, ei) {
        if (this.timerInterval) return;

        let remaining = parseInt(
          this.users[this.currentUser].plans[pi].exercises[ei].timer || 75,
          10
        );

        UI.modal(`
          <div class="modal-head">
            <h3 style="margin:0;">Pause</h3>
            <button onclick="UI.closeModal()">‚úï</button>
          </div>
          <div id="timer" style="font-size:54px;text-align:center;font-weight:900;padding:14px 0;">
            ${remaining}
          </div>
          <div class="exercise-actions" style="justify-content:center;">
            <button onclick="App.stopTimer()">Abbrechen</button>
          </div>
        `);

        this.timerInterval = setInterval(() => {
          remaining--;
          const el = document.getElementById('timer');
          if (el) el.textContent = remaining;

          if (remaining <= 0) {
            this.stopTimer(false);
            UI.modal(`
              <div class="big-alert">WEITER ROLLMOPS</div>
              <div class="exercise-actions" style="justify-content:center;">
                <button class="primary" onclick="UI.closeModal()">OK</button>
              </div>
            `);
          }
        }, 1000);
      }

      static stopTimer(closeModal = true) {
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
          this.timerInterval = null;
        }
        if (closeModal) UI.closeModal();
      }
    }

    window.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>

</html>
